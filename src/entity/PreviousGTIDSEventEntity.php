<?php


namespace sinri\BinlogReader\entity;


class PreviousGTIDSEventEntity extends BaseEventEntity
{
    protected $count;
    protected $gtids = [];

    /**
     * @inheritDoc
     */
    public function getHumanReadableDescription()
    {
        //return 'Mixed Body: ' . PHP_EOL . $this->bodyBuffer->showAsHexMatrix();

        $string = "Previous-GTIDs Total " . $this->count . PHP_EOL;
        foreach ($this->gtids as $gtid) {
            $string .= $gtid . PHP_EOL;
        }
        return $string;
    }

    /**
     * @inheritDoc
     */
    public function parseBodyBuffer()
    {
        $this->count = $this->bodyBuffer->readNumberWithSomeBytesLE(0, 8);
        $offset = 8;

        for ($i = 0; $i < $this->count; $i++) {
            $sub = $this->bodyBuffer->getSubByteBuffer($offset, 16);
            $offset += 16;
            $x = $this->bodyBuffer->readNumberWithSomeBytesLE($offset, 8);
            $offset += 8;
            $y = $this->bodyBuffer->readNumberWithSomeBytesLE($offset, 8);
            $offset += 8;
            $z = $this->bodyBuffer->readNumberWithSomeBytesLE($offset, 8);
            $offset += 8;

            $gtid = $sub->showAsHexIDString([4, 2, 2, 2, 6], '-') . ':' . $x . '-' . ($z - $y);
            $this->gtids[] = $gtid;
        }
    }

    /*
# 4285848d-a6ae-11e6-91c1-6c92bf367cf0:1-17922622671,
# 51a6abbb-a6ae-11e6-91c1-70106faffb90:1-88249621,
# 7ee6271e-0170-11e6-9c3e-ac853d9d5301:1-89522786,
# 8a04147a-5fd6-11e6-83cd-1051721b3b63:1-152860098,
# 9406a211-0170-11e6-9c3f-ac853d9f5442:1-4,
# 9a955efa-5fd6-11e6-83ce-6c92bf2c15e5:1-269679496,
# ca26641b-c772-11e7-acc2-7cd30ae4392a:1-2173000286
#0x000000       ,       0x07,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x42,0x85,
#0x00000a       ,       0x84,0x8d,0xa6,0xae,0x11,0xe6,0x91,0xc1,0x6c,0x92,
#0x000014       ,       0xbf,0x36,0x7c,0xf0,
    0x01,0x00,0x00,0x00,0x00,0x00,
#0x00001e       ,       0x00,0x00,
    0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
#0x000028       ,       0xd0,0x84,0x45,0x2c,0x04,0x00,0x00,0x00,
    0x51,0xa6,
#0x000032       ,       0xab,0xbb,0xa6,0xae,0x11,0xe6,0x91,0xc1,0x70,0x10,
#0x00003c       ,       0x6f,0xaf,0xfb,0x90,
    0x01,0x00,0x00,0x00,0x00,0x00,
#0x000046       ,       0x00,0x00,
    0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
#0x000050       ,       0x16,0x95,0x42,0x05,0x00,0x00,0x00,0x00,
    0x7e,0xe6,
#0x00005a       ,       0x27,0x1e,0x01,0x70,0x11,0xe6,0x9c,0x3e,0xac,0x85,
#0x000064       ,       0x3d,0x9d,0x53,0x01,0x01,0x00,0x00,0x00,0x00,0x00,
#0x00006e       ,       0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
#0x000078       ,       0x63,0x02,0x56,0x05,0x00,0x00,0x00,0x00,0x8a,0x04,
#0x000082       ,       0x14,0x7a,0x5f,0xd6,0x11,0xe6,0x83,0xcd,0x10,0x51,
#0x00008c       ,       0x72,0x1b,0x3b,0x63,0x01,0x00,0x00,0x00,0x00,0x00,
#0x000096       ,       0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
#0x0000a0       ,       0xc3,0x75,0x1c,0x09,0x00,0x00,0x00,0x00,0x94,0x06,
#0x0000aa       ,       0xa2,0x11,0x01,0x70,0x11,0xe6,0x9c,0x3f,0xac,0x85,
#0x0000b4       ,       0x3d,0x9f,0x54,0x42,0x01,0x00,0x00,0x00,0x00,0x00,
#0x0000be       ,       0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
#0x0000c8       ,       0x05,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x9a,0x95,
#0x0000d2       ,       0x5e,0xfa,0x5f,0xd6,0x11,0xe6,0x83,0xce,0x6c,0x92,
#0x0000dc       ,       0xbf,0x2c,0x15,0xe5,0x01,0x00,0x00,0x00,0x00,0x00,
#0x0000e6       ,       0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
#0x0000f0       ,       0x89,0xfb,0x12,0x10,0x00,0x00,0x00,0x00,0xca,0x26,
#0x0000fa       ,       0x64,0x1b,0xc7,0x72,0x11,0xe7,0xac,0xc2,0x7c,0xd3,
#0x000104       ,       0x0a,0xe4,0x39,0x2a,0x01,0x00,0x00,0x00,0x00,0x00,
#0x00010e       ,       0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
#0x000118       ,       0x5f,0x5a,0x85,0x81,0x00,0x00,0x00,0x00,
     */
}